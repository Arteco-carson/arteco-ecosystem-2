name: Fine Art Ecosystem CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AZURE_WEBAPP_NAME: arteco-fineartapi-prod   # set this to your application's name
  AZURE_WEBAPP_PACKAGE_PATH: '.'             # set this to the path to your web app project
  DOTNET_VERSION: '8.0'                      # set this to the dotnet version to use

jobs:
  # This first job determines which parts of the project have changed.
  changes:
    runs-on: ubuntu-latest
    outputs:
      acm-frontend: ${{ steps.filter.outputs.acm-frontend }}
      dr-frontend: ${{ steps.filter.outputs.dr-frontend }}
      api: ${{ steps.filter.outputs.api }}
      acm-mobile: ${{ steps.filter.outputs.acm-mobile }}
      dr-mobile: ${{ steps.filter.outputs.dr-mobile }}
    steps:
    - uses: actions/checkout@v3
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          # acm-frontend:
          #   - 'arteco-acm-frontend/**'
          # dr-frontend:
          #   - 'arteco-dr-frontend/**'
          api:
            - 'FineArtApi/**'
          # acm-mobile:
          #   - 'arteco-acm-mobile/**'
          # dr-mobile:
          #   - 'arteco-dr-mobile/**'

  # Job for the Arteco Collection Manager Frontend
#  build-acm-frontend:
#    needs: changes
#    if: needs.changes.outputs.acm-frontend == 'true'
#    runs-on: ubuntu-latest
#    defaults:
#      run:
#        working-directory: ./arteco-acm-frontend
#    steps:
#    - uses: actions/checkout@v3
#    - name: Set up Node.js
#      uses: actions/setup-node@v3
#      with:
#        node-version: '20'
#        cache: 'npm'
#        cache-dependency-path: arteco-acm-frontend/package-lock.json
#    - name: Install dependencies
#      run: npm install
#    - name: Run tests
#      run: npm test -- --watchAll=false
#    - name: Build
#      run: npm run build
#      env:
#        REACT_APP_API_URL: "https://arteco-fineartapi-prod-bxetekage3a2b6em.eastus2-01.azurewebsites.net/"
#        CI: false
#    - name: Upload artifact for deployment job
#      uses: actions/upload-artifact@v4
#      with:
#        name: acm-frontend-app
#        path: arteco-acm-frontend/build

#  deploy-acm-frontend:
#    needs: [changes, build-acm-frontend]
#    if: needs.changes.outputs.acm-frontend == 'true'
#    runs-on: ubuntu-latest
#    name: Deploy ACM Frontend Job
#    steps:
#      - name: Download artifact from build job
#        uses: actions/download-artifact@v4
#        with:
#          name: acm-frontend-app
#      - name: Deploy to Azure Static Web App
#        id: builddeploy
#        uses: Azure/static-web-apps-deploy@v1
#        with:
#          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}
#          repo_token: ${{ secrets.GITHUB_TOKEN }}
#          action: "upload"
#          app_location: "/" # App source code path (root of artifact)
#          api_location: "" # Api source code path - optional
#          output_location: "" # Built app content directory - optional, handled by artifact

  # Job for the Arteco Defect Reporting Frontend
#  build-dr-frontend:
#    needs: changes
#    if: needs.changes.outputs.dr-frontend == 'true'
#    runs-on: ubuntu-latest
#    defaults:
#      run:
#        working-directory: ./arteco-dr-frontend
#    steps:
#    - uses: actions/checkout@v3
#    - name: Set up Node.js
#      uses: actions/setup-node@v3
#      with:
#        node-version: '20'
#        cache: 'npm'
#        cache-dependency-path: arteco-dr-frontend/package-lock.json
#    - name: Install dependencies
#      run: npm install
#    - name: Build
#      run: npm run build

  # Job for the .NET API Backend
  build-api:
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore
      run: dotnet restore ./FineArtApi/FineArtApi.csproj

    - name: Build
      run: dotnet build ./FineArtApi/FineArtApi.csproj --configuration Release --no-restore

    - name: Publish
      run: dotnet publish ./FineArtApi/FineArtApi.csproj --configuration Release --output '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/myapp' 

    - name: Upload artifact for deployment job
      uses: actions/upload-artifact@v4
      with:
        name: .net-app
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/myapp

  deploy-api:
    needs: build-api
    runs-on: ubuntu-latest
    steps:
    - name: Download artifact from build job
      uses: actions/download-artifact@v4
      with:
        name: .net-app

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .

  # Job for the Arteco Collection Manager Mobile App
#  install-acm-mobile-deps:
#    needs: changes
#    if: needs.changes.outputs.acm-mobile == 'true'
#    runs-on: ubuntu-latest
#    defaults:
#      run:
#        working-directory: ./arteco-acm-mobile
#    steps:
#    - uses: actions/checkout@v3
#    - name: Set up Node.js
#      uses: actions/setup-node@v3
#      with:
#        node-version: '20'
#        cache: 'npm'
#        cache-dependency-path: arteco-acm-mobile/package-lock.json
#    - name: Install dependencies
#      run: npm install

  # Job for the Arteco Defect Reporting Mobile App
#  install-dr-mobile-deps:
#    needs: changes
#    if: needs.changes.outputs.dr-mobile == 'true'
#    runs-on: ubuntu-latest
#    defaults:
#      run:
#        working-directory: ./arteco-dr-mobile
#    steps:
#    - uses: actions/checkout@v3
#    - name: Set up Node.js
#      uses: actions/setup-node@v3
#      with:
#        node-version: '20'
#        cache: 'npm'
#        cache-dependency-path: arteco-dr-mobile/package-lock.json
#    - name: Install dependencies
#      run: npm install
